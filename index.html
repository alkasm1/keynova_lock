<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Keynova Lock</title>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>
  <style>
    body { font-family: 'Tajawal', Arial; background: #1f1f1f; color: #fff; padding: 20px; text-align: center; }
    input[type="file"], button, select { margin-top: 10px; padding: 10px; font-size: 1em; border-radius: 5px; }
    button { background: #ff8800; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #e67600; }
    select { background: #2c2c2c; color: #fff; border: 1px solid #666; }
    .result { margin-top: 30px; font-size: 1.2em; }
    .success { color: #00ff99; }
    .fail { color: #ff4444; }
    h1 { color: #ff8800; }
  </style>
</head>
<body>

  <h1>🔐 Keynova Lock</h1>
  <p>التحقق بالمفتاح البصري قبل الوصول لإعدادات التطبيق</p>

  <!-- واجهة التحقق -->
  <h3>🔓 محاولة الفتح</h3>
  <input type="file" id="verifyInput" accept="image/*" />
  <button onclick="verifyKey()">تحقق من الصورة</button>
  <div class="result" id="result"></div>

  <!-- خيارات تظهر بعد التحقق -->
  <div id="securedActions" style="display:none;">
    <h3>🔧 خيارات الإعداد</h3>
    <button onclick="goToKeyChange()">🛠️ تغيير المفتاح</button>
    <button onclick="goToProtection()">🗂️ حماية تطبيق أو ملف</button>
  </div>

  <!-- واجهة تغيير المفتاح -->
  <div id="keySection" style="display:none;">
    <h3>🖼️ تعيين صورة جديدة كمفتاح</h3>
    <input type="file" id="setKeyInput" accept="image/*" />
    <button onclick="setKey()">حفظ المفتاح الجديد</button>
  </div>

  <!-- واجهة حماية التطبيقات أو الملفات -->
  <div id="protectionSection" style="display:none;">
    <h3>🛡️ الحماية البصرية</h3>
    <p>اختر الهدف الذي تريد حمايته بواسطة المفتاح البصري:</p>

    <select id="protectedTarget">
      <option value="">— اختر —</option>
      <option value="images">📸 الصور</option>
      <option value="docs">📄 المستندات</option>
      <option value="apps">📱 التطبيقات</option>
      <option value="custom">🧩 اختيار مخصص</option>
    </select>

    <button onclick="protectSelected()">🔒 تطبيق الحماية</button>
    <div id="protectionResult" class="result"></div>
  </div>

  <script>
    async function calculateHash(file) {
      const buffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function verifyKey() {
      const file = document.getElementById("verifyInput").files[0];
      if (!file) return alert("يرجى اختيار صورة للتحقق منها");

      const storedHash = localStorage.getItem("keynova_hash");
      if (!storedHash) {
        document.getElementById("result").innerHTML = "⚠️ لم يتم تعيين مفتاح مسبقًا.";
        document.getElementById("result").className = "result fail";
        return;
      }

      const currentHash = await calculateHash(file);
      const resultDiv = document.getElementById("result");

      if (currentHash === storedHash) {
        resultDiv.innerHTML = "✅ تم التحقق بنجاح!";
        resultDiv.className = "result success";
        document.getElementById("securedActions").style.display = "block";
      } else {
        resultDiv.innerHTML = "❌ الصورة لا تطابق المفتاح المخزن.";
        resultDiv.className = "result fail";
      }
    }

    async function setKey() {
      const file = document.getElementById("setKeyInput").files[0];
      if (!file) return alert("يرجى اختيار صورة لتعيينها كمفتاح جديد");
      const hash = await calculateHash(file);
      localStorage.setItem("keynova_hash", hash);
      alert("✅ تم حفظ المفتاح الجديد!");
    }

    function goToKeyChange() {
      document.getElementById("keySection").style.display = "block";
    }

    function goToProtection() {
      document.getElementById("protectionSection").style.display = "block";
    }

    function protectSelected() {
      const target = document.getElementById("protectedTarget").value;
      const result = document.getElementById("protectionResult");

      if (!target) {
        result.innerHTML = "⚠️ يرجى اختيار هدف للحماية.";
        result.className = "result fail";
        return;
      }

      result.innerHTML = `✅ تم تفعيل الحماية على "${target}" باستخدام المفتاح البصري.`;
      result.className = "result success";

      // يمكن لاحقًا حفظ الحماية في localStorage أو إرسالها لسيرفر
    }
  </script>

</body>
</html>
